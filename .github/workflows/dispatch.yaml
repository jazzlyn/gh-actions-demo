---
  name: dispatch

  on:
    workflow_dispatch:
    push:
      branches:
        - main
      tags:
        - "v*.*.*-rc*"
        - "v*.*.*"

  jobs:
    docker-build-push:
      uses: "strg-at/github-workflows/.github/workflows/docker-build-push-github.yaml@v0.4.0"
      with:
        runner: '["ubuntu-latest"]'

    dump_contexts_to_log:
      runs-on: ubuntu-latest
      steps:
        - name: Dump GitHub context
          id: github_context_step
          run: echo '${{ toJSON(github) }}'

    integration-dispatch:
      if: ${{ github.ref == 'refs/heads/main' }}
      needs: [docker-build-push]
      uses: "strg-at/github-workflows/.github/workflows/repo-dispatch.yaml@v0.4.0"
      with:
        runner: '["ubuntu-latest"]'
        sha: ${{ fromJSON(needs.docker-build-push.outputs.metadata).labels['org.opencontainers.image.version'] }}
        repository: jazzlyn/gh-actions-demo
        dispatch-event: test-event
      secrets:
        github-app-id: ${{ secrets.JAZZLYN_BOT_GITHUB_APP_ID }}
        github-app-key: ${{ secrets.JAZZLYN_BOT_GITHUB_PEM }}

    staging-dispatch:
      if: ${{ (github.ref == 'refs/tags/v*.*.*-rc**') && (startsWith(github.event.base_ref, 'refs/heads/release/')) }}
      needs: [docker-build-push]
      uses: "strg-at/github-workflows/.github/workflows/repo-dispatch.yaml@v0.4.0"
      with:
        runner: '["ubuntu-latest"]'
        sha: ${{ fromJSON(needs.docker-build-push.outputs.metadata).labels['org.opencontainers.image.version'] }}
        repository: jazzlyn/gh-actions-demo
        dispatch-event: test-event
      secrets:
        github-app-id: ${{ secrets.JAZZLYN_BOT_GITHUB_APP_ID }}
        github-app-key: ${{ secrets.JAZZLYN_BOT_GITHUB_PEM }}

    production-dispatch:
      if: ${{ startsWith(github.event.base_ref, 'refs/heads/release/') && contains(github.ref, 'refs/tags/v*.*.*') }}
      needs: [docker-build-push]
      uses: "strg-at/github-workflows/.github/workflows/repo-dispatch.yaml@v0.4.0"
      with:
        runner: '["ubuntu-latest"]'
        sha: ${{ fromJSON(needs.docker-build-push.outputs.metadata).labels['org.opencontainers.image.version'] }}
        repository: jazzlyn/gh-actions-demo
        dispatch-event: test-event
      secrets:
        github-app-id: ${{ secrets.JAZZLYN_BOT_GITHUB_APP_ID }}
        github-app-key: ${{ secrets.JAZZLYN_BOT_GITHUB_PEM }}
